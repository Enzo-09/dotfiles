"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[82094],{402245:(e,n,t)=>{t.r(n),t.d(n,{SavePageToOPFS:()=>T});t(517642),t(658004),t(733853),t(845876),t(432475),t(515024),t(731698),t(898992),t(354520),t(908872);var a=t(296540),r=()=>t(395361),i=()=>t(484714),o=()=>t(847249),c=()=>t(452540),s=()=>t(134025),u=()=>t(179034),d=()=>t(963589);var l=()=>t(495074),g=()=>t(351360),k=()=>t(733539),f=(t(944114),()=>t(585515)),v=()=>t(577449),m=()=>t(631616),p=()=>t(388821),h=()=>t(780054),b=()=>t(870618),C=()=>t(53429);var _=()=>t(227417);function y(e){const n=(0,i().v3)(),t=(0,_().S)(),[y,T]=(0,a.useState)(!1),S=(0,d().X)("opfs_save_page_strategy_revision_tracking"),w=(0,d().X)("opfs_save_page_strategy_sync_tracking"),L=(0,d().X)("opfs_save_page_strategy_background"),P=(0,d().X)("opfs_save_page_strategy_navigation"),E=(0,o().uB)(g().default),A={revisionTracking:S,syncTracking:w,backgrounded:L,navigation:P},B=(0,a.useCallback)((e=>{var t;null!==(t=E.state.currentLoadingContainerStore)&&void 0!==t&&t.state.endOfResultsReached&&async function(e,n){const t=(0,C().getOPFSPageCache)();if(!n.currentUser.id||!g().default.state.currentSpaceStore||!t)return;performance.mark("generate-chunk-start");const a=[];let r={stack:[]};for(;r;){const t=p().RecordMapWithRole.create(),i=await(0,f().T)({page:{spaceId:g().default.state.currentSpaceStore.id,id:e},limit:30,cursor:r,verticalColumns:!0,baseUrl:h().A.domainBaseUrl,publicDomainName:h().A.publicDomainName,shouldTraverseToggleBlocks:!0,loadButtonBlockChildren:!0,contentBatchSize:30},v().h.fromMonomorphicFunctionUnsafe((async e=>{const a=await b().h7({environment:n,pointer:e,useInMemoryCacheOnly:!0,skipAccessWrites:!0});return a?(t.setModelAndRole(e,a.model,a.role),a.model):void 0})));if(a.push(t),0===i.cursorValue.stack.length){r=void 0;break}r=i.cursorValue}performance.mark("generate-chunk-end"),performance.measure("generate-chunk","generate-chunk-start","generate-chunk-end"),await t.write((0,m().createOPFSPageCacheKey)(n.currentUser.id,e),a)}(e,n).catch((e=>{}))}),[n,E]),D=(0,r().Y)((e=>{window.requestIdleCallback?window.requestIdleCallback((()=>B(e)),{timeout:1e4}):setTimeout((()=>B(e)),2e3)}),1e3),I=(0,a.useCallback)((function(){for(var n=arguments.length,t=new Array(n),a=0;a<n;a++)t[a]=arguments[a];for(const r of t){const n=(0,c().W8)({combinedId:r.combinedId});"track_page"===r.type&&n.id===e?T(!0):"untrack_page"===r.type&&n.id===e&&T(!1)}}),[e]);(0,a.useEffect)((()=>{if(!A.revisionTracking&&!A.syncTracking)return void l().A.removeListener(I);l().A.addListener(I);return l().A.getPageBlockTrackerForPage({table:u().ev,id:e})&&T(!0),()=>l().A.removeListener(I)}),[e,I,A.revisionTracking,A.syncTracking]);const U=(0,a.useMemo)((()=>{if(!1!==y)return l().A.getPageBlockTrackerForPage({table:u().ev,id:e})}),[e,y]),F=(0,a.useCallback)((()=>{if(!U)return;performance.mark("revisionChangeDetectionStart");const n=k().default.state,t=n.undoStack[n.undoStack.length-1];if(!t)return;const a=t.transactions.reduce(((e,n)=>{for(const t of n.operations)if(t.pointer.table===u().ev&&e.add(t.pointer.id),(0,s().mP)(t)&&t.additionalUpdatedPointers)for(const n of t.additionalUpdatedPointers)n.table===u().ev&&e.add(n.id);return e}),new Set),r=U.getLiveBlocks().filter((e=>{let{blockStore:n}=e;return a.has(n.id)}));performance.mark("revisionChangeDetectionEnd");performance.measure("revisionChangeDetection","revisionChangeDetectionStart","revisionChangeDetectionEnd");r.length>0&&D(e)}),[U,e,D]);(0,a.useEffect)((()=>{if(t&&A.revisionTracking&&U)return k().default.addListener(F),()=>k().default.removeListener(F)}),[t,A.revisionTracking,U,F]);const M=(0,a.useCallback)((()=>{D(e)}),[e,D]),O=(0,r().Y)(M,50);(0,a.useEffect)((()=>{if(t&&A.syncTracking&&U)return U.addListener(O),()=>{U.removeListener(O)}}),[t,A.syncTracking,U,O]),(0,a.useEffect)((()=>{if(A.navigation)return()=>{D(e)}}),[A.navigation,e,D]);!function(e,n){const t=(0,r().Y)(e,(null==n?void 0:n.debounceTimeMs)??256),i=(0,a.useCallback)((()=>{document.hidden&&t()}),[t]),o=(0,a.useCallback)((()=>{t()}),[t]);(0,a.useEffect)((()=>(document.addEventListener("visibilitychange",i),window.addEventListener("blur",o),()=>{document.removeEventListener("visibilitychange",i),window.removeEventListener("blur",o),t.cancel()})),[t,i,o])}((0,a.useCallback)((()=>{t&&A.backgrounded&&D(e)}),[t,A.backgrounded,e,D]))}function T(e){let{pageId:n}=e;return y(n),null}}}]);