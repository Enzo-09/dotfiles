"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[83324],{183324:(e,t,a)=>{a.r(t),a.d(t,{attemptServerBackedLocalDuplicate:()=>oe,duplicateBlock:()=>re,localDuplicate:()=>ee,serverDuplicate:()=>te,shouldUseDuplicateAndTranslateTemplateBlock:()=>ce,shouldUseDuplicateTemplateBlock:()=>ne});a(16280),a(944114),a(898992),a(823215),a(803949),a(581454),a(737550);var o=()=>a(110192),r=()=>a(857639),n=()=>a(416504),c=()=>a(386164),i=()=>a(388821),s=()=>a(912720),l=()=>a(199378),p=()=>a(179034),d=()=>a(665344),u=()=>a(854150),m=()=>a(502800),g=()=>a(763824),v=()=>a(534177),_=()=>a(435345),y=()=>a(583835);const I=(0,y().Dv)("duplicateAndTranslateTemplateBlock"),k=(0,y().Dv)("duplicateTemplateBlock");var f=()=>a(466614),S=()=>a(970330),h=()=>a(679156),b=()=>a(449506),B=()=>a(171718),T=()=>a(901389),C=()=>a(357625),M=()=>a(910302),w=()=>a(915457),A=()=>a(666144),L=()=>a(319975),P=()=>a(751156),R=()=>a(898486),D=()=>a(974233),E=()=>a(594794),x=()=>a(611191),O=()=>a(603815),z=()=>a(972435),N=()=>a(494043),F=()=>a(406792);class U{constructor(e){this.environment=void 0,this.metricName=void 0,this.startMetric=void 0,this.prevLapMetric=void 0,this.extraData=void 0,this.environment=e.environment,this.metricName=e.metricName,this.startMetric=F().default.mark(e.metricName),this.prevLapMetric=F().default.mark(e.metricName),this.extraData=e.extraData??{}}mark(e){F().default.measure(this.prevLapMetric,{environment:this.environment,data:{type:e,...this.extraData},sampleDecision:"default"}),this.prevLapMetric=F().default.mark(this.metricName)}end(){F().default.measure(this.startMetric,{environment:this.environment,data:{type:"total",...this.extraData},sampleDecision:"default"})}}var V=()=>a(351360),j=()=>a(227440),J=()=>a(508496),$=()=>a(630116),q=()=>a(261450),W=(a(354520),()=>a(700500)),K=()=>a(416845),G=()=>a(899193),X=()=>a(246826),H=()=>a(345913);function Y(e){for(const t of e)G().L7(t.id)}function Z(e,t){for(const a of t)G().DW(e,a.id)}var Q=()=>a(59110);function ee(e){var t,a,n;const{environment:c,sourceBlockId:i,targetBlockPointer:s,sourceBlockSubtree:l,targetInMemoryRecordCache:d,options:u,shallowCopyNavigableBlock:m,duplicateDiscussions:g,transaction:v,installationImprint:_,templateInstallationMetadata:y,actionStartTimestamp:I,stopwatch:k}=e;null==k||k.mark("local_duplicate_start");const f=s.spaceId,S=null===(t=l.getModel({id:i,table:p().ev}))||void 0===t?void 0:t.spaceId,b=[],C=I??performance.now(),M=f??(null===(a=V().default.state.currentSpaceStore)||void 0===a?void 0:a.id)??(null===(n=V().default.state.mainEditorCurrentBlockStore)||void 0===n?void 0:n.getSpaceId()),w=M?c.idCreator.getSpaceIdCreatorSync(M):void 0,{targetBlockStore:A,originalToDuplicate:P,subtreeSize:R}=B().j({environment:c,sourceBlockId:i,targetBlockPointer:s,sourceBlockSubtree:l,targetRecordCache:d,transaction:v,deepCopyTransclusionContainers:Boolean(u.deepCopyTransclusionContainers),duplicateDiscussions:g,shallowCopyNavigableBlock:m,resolveTemplateVariables:u.resolveTemplateVariables,preventLegacyTransclusions:u.preventLegacyTransclusions,createLegacyTransclusionCopyIndicator:{onCreate(e){b.push(e)}},installationImprint:_,templateInstallationMetadata:y,isTemplateInstantiation:u.isTemplateInstallation,spaceIdCreator:w,appendContentOnly:u.appendContentOnly});return null==k||k.mark("local_duplicate_initialize_template_success"),ie({environment:c,type:"local_duplicate_initialize_template_success",data:{message:"Successful initialize template",targetSpaceId:f,sourceSpaceId:S,targetBlockStore:A,subtreeSize:R}}),function(e){const{environment:t,userAction:a,startTime:o,succeeded:r,totalBlocks:n,isLocal:c}=e,i=J().default.checkGate({gateName:"duplicate_block_await_post_submit_transaction"}),s=J().default.checkGate({gateName:"layouts_views_module_strip_child_cvb_of_simple_layouts"});(0,q().E)({environment:t,success:r,time:performance.now()-o,user_action:a,is_duplication_local:c,is_await_post_submit_transaction:i,strip_layouts_child_collection_view_block_enabled:s,duplication_size:n})}({environment:c,userAction:v.getUserActionForAnalyticsPurposesOnly()||"",startTime:C,isLocal:!0,totalBlocks:R,succeeded:!0}),f!==S&&r().log({level:"info",from:"localDuplicate",type:"local_duplicate_across_spaces",data:{sourceSpaceId:S,targetSpaceId:f,sourceBlockId:i,subTreeSize:l.getSize()}}),u.addCopyName&&A&&A.isNavigableBlock()&&(!function(e){const{environment:t,transaction:a,targetBlockStore:r}=e,n=r.getTitleStore();if(!n)return;const c=n.getValue(),i=(0,o().g)(c);L().R9({environment:t,store:n,value:i,transaction:a}),ie({environment:t,type:"local_duplicate_text_set_value",data:{value:i,titleStoreId:n.id,targetBlockId:r.id}})}({environment:c,transaction:v,targetBlockStore:A}),null==k||k.mark("local_duplicate_add_copy_name")),b.length&&(!function(e){const{environment:t,transaction:a,targetBlockStore:o,targetRecordCache:r,sourceSpaceId:n,legacyTransclusionCopyIndicators:c,options:i,templateInstallationMetadata:s}=e,l=!j().A.state.online;l&&T().f1(z().A.formatMessage(q().V.offlineError));for(const d of c){ie({environment:t,type:"local_duplicate_legacy_transclusion_copy_indicators",data:{message:"Iterating legacyTransclusionCopyIndicators",info:d}});const e=o.getSpaceId(),c=$().Bv.createChildStore(o,{table:p().ev,id:d.duplicateBlockId});te({environment:t,targetSpaceId:e,targetInMemoryRecordCache:r,transaction:a,userActionSuffix:" (legacy transclusion fix)",sourceBlocks:[{id:d.sourceBlockId,spaceId:n}],copyIndicators:[c],options:{...i,addCopyName:!1,convertExternalObjectInstancesToPlaceholders:i.convertExternalObjectInstancesToPlaceholders??!1},templateInstallationMetadata:s,shouldAttemptServerBackedLocalDuplication:!1})}h().hi(t,{offline:l,num_blocks_duplicated:c.length,user_action:a.getUserActionForAnalyticsPurposesOnly()})}({environment:c,transaction:v,targetBlockStore:A,targetRecordCache:d,sourceSpaceId:S,legacyTransclusionCopyIndicators:b,options:u,templateInstallationMetadata:y}),null==k||k.mark("local_duplicate_legacy_transclusion_fix")),null==k||k.mark("local_duplicate_success"),{targetBlockStore:A,originalToDuplicate:P}}function te(e){const{environment:t,sourceBlocks:a,targetInMemoryRecordCache:o,transaction:r,options:c,targetSpaceId:s,userActionSuffix:l,installationImprint:d,templateInstallationMetadata:u={},applyTranslationMap:m,shouldAttemptServerBackedLocalDuplication:y,shouldUseSynchronousDuplicationAPI:f,actionStartTimestamp:S,stopwatch:h}=e;if(null==h||h.mark("server_duplicate_start"),0===a.length)throw le({environment:t,type:"server_duplicate_no_source_blocks",data:{targetSpaceId:s,options:c}}),new Error("Must duplicate at least one block");if((0,v().O9)(m)&&1!==a.length)throw le({environment:t,type:"server_duplicate_apply_translation_map_no_source_blocks",data:{sourceBlocksLength:a.length,targetSpaceId:s,options:c}}),new Error("applyTranslationMap currently only supported for single (page) block duplication");const B=e.copyIndicators??function(e){const{environment:t,sourceBlocks:a,targetRecordCache:o,transaction:r,spaceId:n}=e,c=a.map(((e,a)=>X().Wv({environment:t,type:W().xd.copyIndicator,inMemoryRecordCache:o,transaction:r,spaceId:n})));if(c.length!==a.length)throw new Error("copyIndicators must be same length as source blocks");if(!(0,v().EI)(c))throw new Error("copyIndicators must cannot be empty");return c}({environment:t,sourceBlocks:a,targetRecordCache:o,transaction:r,spaceId:s});null==h||h.mark("create_copy_indicators");const T=g().yX(),w=S??performance.now();return r.postSubmitCallbacks.push((async e=>{if(null==h||h.mark("transaction_post_submit_callback"),e)return se({environment:t,type:"server_duplicate_transaction_post_submit_callback_error",data:{copyIndicatorIds:B.map((e=>e.id)),error:e,targetSpaceId:s,options:c}}),void function(e,t){const a=(0,K().op4)(e)?(0,R().DX)(z().A.getIntl(),e):void 0;t.resolve({status:"error",errorMessage:a??z().A.formatMessage(q().V.unknownError),error:e})}(e,T);const o=`${r.getUserActionForAnalyticsPurposesOnly()}${l?` ${l}`:""}`;if(function(e){for(const t of e)G().n_(t.id)}(B),null==h||h.mark("initialize_copy_indicators_progress_state"),y&&1===a.length){const{success:e}=await oe({environment:t,sourceBlockPointer:a[0],targetBlockStore:B[0],userAction:o,options:c,templateInstallationMetadata:u,actionStartTimestamp:w,stopwatch:h});if(e)return null==h||h.mark("server_backed_local_duplicate_success"),Y(B),void T.resolve({status:"success"});null==h||h.mark("server_backed_local_duplicate_failure")}const g=await async function(e){const{environment:t,copyIndicators:a,sourceBlocks:o,targetSpaceId:r,options:c,userAction:i,templateInstallationMetadata:s,installationImprint:l,applyTranslationMap:p,shouldUseSynchronousDuplicationAPI:d,stopwatch:u}=e,m=o[0].spaceId||r,g=o.map((e=>({...e,spaceId:e.spaceId||m}))),y=a.map((e=>({id:e.id,spaceId:e.getSpaceId()}))),f=!!c.resolveTemplateVariables&&{currentUserId:t.currentUser.id,currentTimeZone:(0,n().P)()},S={sourceBlocks:g,targetBlocks:y,userAction:i,addCopyName:c.addCopyName,deepCopyTransclusionContainers:c.deepCopyTransclusionContainers,convertExternalObjectInstancesToPlaceholders:c.convertExternalObjectInstancesToPlaceholders,duplicateOnlyCollectionSchema:c.duplicateOnlyCollectionSchema,createActivities:c.createActivities,resolveTemplateVariables:f},h=ne(s.source),B=ce(c.shouldTranslate,c.sourceLanguage,c.targetLanguage);let T;if(h)if(d)T=await async function(e){const{environment:t,request:a,stopwatch:o}=e,r=await b().callApi({eventName:"duplicateTemplateBlockSynchronously",environment:t,data:a});if(null==o||o.mark("duplicate_template_synchronous_finished"),"failed"===r.type)return{success:!1,error:r.error,errorMessage:(0,R().A)(z().A.getIntl(),r.error)};return{success:!0,recordIdMapJson:r.data.recordIdMapJson}}({environment:t,request:{...S,sourceLanguage:c.sourceLanguage,targetLanguage:c.targetLanguage}}),null==u||u.mark("duplicate_template_synchronously_finished");else{const e=C().UT(t,k,{...S,source:s.source,context:s.context,isEmailShared:s.isEmailShared,isFromDuplicateParam:s.isFromDuplicateParam});T=await ae({environment:t,copyIndicators:a,targetSpaceId:r,options:c,userAction:i,duplicateBlockIterator:e}),null==u||u.mark("duplicate_template_finished")}else if(B){const e=C().UT(t,I,{...S,sourceLanguage:c.sourceLanguage,targetLanguage:c.targetLanguage});T=await ae({environment:t,copyIndicators:a,targetSpaceId:r,options:c,userAction:i,duplicateBlockIterator:e}),null==u||u.mark("duplicate_and_translate_template_finished")}else if(d)T=await async function(e){const{environment:t,request:a}=e,o=await b().callApi({eventName:"duplicateBlockSynchronously",environment:t,data:a});if("failed"===o.type)return{success:!1,error:o.error,errorMessage:(0,R().A)(z().A.getIntl(),o.error)};return{success:!0,recordIdMapJson:o.data.recordIdMapJson}}({environment:t,request:{...S,installationImprint:l,returnRecordIdMapJson:(0,v().O9)(p)}}),null==u||u.mark("duplicate_block_synchronously_finished");else{const e=C().UT(t,_().w,{...S,installationImprint:l,returnRecordIdMapJson:(0,v().O9)(p)});T=await ae({environment:t,copyIndicators:a,targetSpaceId:r,options:c,userAction:i,duplicateBlockIterator:e}),null==u||u.mark("duplicate_block_finished")}return T}({environment:t,copyIndicators:B,sourceBlocks:a,targetSpaceId:s,options:c,userAction:o,templateInstallationMetadata:u,installationImprint:d,applyTranslationMap:m,shouldUseSynchronousDuplicationAPI:f,stopwatch:h});if(null==h||h.mark("perform_server_duplicate_finished"),ie({environment:t,type:"server_duplicate_duplicate_block_iterator_success",data:{result:g,targetSpaceId:s,options:c}}),Y(B),!g.success)return function(e){const{environment:t,copyIndicators:a}=e;b().callApi({eventName:"deleteBlocks",environment:t,data:{blocks:a.filter((e=>e.useCrdt())).map((e=>({id:e.id,spaceId:e.pointer.spaceId}))),permanentlyDelete:!1}}),H().LS({environment:t,blocks:a.filter((e=>!e.useCrdt()))})}({environment:t,copyIndicators:B}),se({environment:t,type:"server_duplicate_iterator_error",data:{errorMessage:g.errorMessage}}),void T.resolve({status:"error",errorMessage:g.errorMessage,error:g.error});(0,v().O9)(m)&&(0,v().O9)(g.recordIdMapJson)&&(!function(e){const{environment:t,blockToTranslateStore:a,applyTranslationMap:o,recordIdMap:r}=e,n=M().Js({translationMap:o,recordIdMap:r});P().createAndCommit({userAction:"serverDuplicate.applyTranslationMap",environment:t,canUndo:!0,perform(e){for(const[o,r]of Object.entries(n)){const n=$().Bv.createChildStore(a,{table:p().ev,id:o,spaceId:a.getSpaceId()});let c;if("title"===r.mapping)c=n.getBlockTitleStore();else if("caption"===r.mapping)c=n.getPropertyStore("caption");else{if("unmapped"===r.mapping)continue;if("properties"===r.mapping){Object.entries(r.properties??{}).forEach((a=>{let[o,r]=a;const c=n.getPropertyStore(o);L().R9({environment:t,store:c,value:r.value,transaction:e})}));continue}(0,v().HB)(r.mapping)}L().R9({environment:t,store:c,value:r.value,transaction:e})}}})}({environment:t,blockToTranslateStore:B[0],applyTranslationMap:m,recordIdMap:i().RecordMapPolymorphic.create(g.recordIdMapJson)}),null==h||h.mark("apply_translation_mapping")),null==h||h.mark("server_duplicate_success"),T.resolve({status:"success"})})),{blockStores:B,onComplete:T.promise}}async function ae(e){var t;const{environment:a,copyIndicators:o,targetSpaceId:r,options:n,duplicateBlockIterator:c}=e;let i;try{for await(const e of c)ie({environment:a,type:"server_duplicate_duplicate_block_iterator",data:{response:e,targetSpaceId:r,options:n}}),Z(e,o),f().$2(a,e),i=e}catch(p){}if(!i||i.error){var s,l;const e=null!==(s=i)&&void 0!==s&&s.error?(0,R().A)(z().A.getIntl(),i.error):z().A.formatMessage(q().V.unknownError);return{success:!1,error:(null===(l=i)||void 0===l?void 0:l.error)??new Error(e),errorMessage:e}}return{success:!0,recordIdMapJson:null===(t=i)||void 0===t?void 0:t.value.recordIdMapJson}}async function oe(e){const{environment:t,sourceBlockPointer:a,targetBlockStore:o,userAction:n,options:p,templateInstallationMetadata:d,recordLimit:u=500,actionStartTimestamp:g,targetInMemoryRecordCache:v,stopwatch:_}=e;null==_||_.mark("attempt_server_backed_local_duplicate_start"),ie({environment:t,type:"server_duplicate_attempt_server_backed_local_duplicate",data:{sourceBlockPointer:a,targetBlockStore:o,targetSpaceId:o.getSpaceId(),options:p}});const y=(0,x().$J)(),I=await async function(e){const{environment:t,sourceBlockPointer:a,targetBlockStore:o,targetInMemoryRecordCache:n,options:s,enableLegacyTransclusionFixing:l,recordLimit:p,userAction:d}=e,u=n??o.inMemoryRecordCache,g={blockId:a.id,allowCopyCollections:!0,requireFullSubtree:!0,skipTransclusionContainerChildren:!s.deepCopyTransclusionContainers,allowCopyExternalObjectInstances:!s.convertExternalObjectInstancesToPlaceholders,includeLegacyTransclusionBlockValues:l,inMemoryRecordCache:u};let v;if(v=(0,Q().loadLocalSubtree)(t,g),!v.recordMap&&u===t.defaultRecordCache.inMemoryRecordCache)try{ie({environment:t,type:"performInexactPagePreload",data:{message:"No local subtree found, performing performInexactPagePreload",loadLocalSubtreeArgs:g}}),await(0,O().A$)(t,{table:"block",id:a.id,spaceId:a.spaceId}),v=(0,Q().loadLocalSubtree)(t,g)}catch(_){r().log({level:"warning",from:"attemptServerBackedLocalDuplicate",type:"persistedRecordCachePreloadError",error:(0,m().convertErrorToLog)(_),data:{message:"Failed to preload subtree from persisted record cache"}})}v.recordMap||(ie({environment:t,type:"loadLocalSubtreeApi",data:{message:"No local subtree found from previous attempts, attemping API call to loadBlockSubtree",currentLocalSubtreeResponse:v}}),v=await async function(e){const{environment:t,sourceBlockPointer:a,recordLimit:o,userAction:n,targetBlockStore:s,loadLocalSubtreeArgs:l}=e;try{const e=await b().callApi({eventName:"loadBlockSubtree",environment:t,data:{block:{id:a.id,spaceId:a.spaceId},shallow:!1,recordCountLimit:o},headers:(0,c().WS)({spaceId:a.spaceId})});if(ie({environment:t,type:"loadBlockSubtreeApiResult",data:{message:"Result from loadBlockSubtree API call",subtreeResult:e,apiArgs:{block:{id:a.id,spaceId:a.spaceId},shallow:!1,recordCountLimit:o}}}),"success"===e.type){const a=i().RecordMapWithRole.create(e.data.subtreeRecordMap);return await A()._O({environment:t,inMemoryRecordCache:l.inMemoryRecordCache,recordMap:a,debugSource:n}),(0,Q().loadLocalSubtree)(t,l)}{const t=(0,D().V)(e);r().log({level:"warning",from:"attemptServerBackedLocalDuplicate",type:"loadBlockSubtreeFailure",data:{message:"Error fetching subtree",miscDataToConvertToString:{error:t,sourceBlockPointer:a,cacheSize:s.inMemoryRecordCache.size,targetBlockPointer:{id:s.id,spaceId:s.getSpaceId(),type:s.getType()},userAction:n}}})}}catch(_){r().log({level:"error",from:"attemptServerBackedLocalDuplicate",type:"subtreeLoadError",error:(0,m().convertErrorToLog)(_),data:{message:"Error loading subtree",miscDataToConvertToString:{sourceBlockPointer:a,cacheSize:s.inMemoryRecordCache.size,targetBlockPointer:{id:s.id,spaceId:s.getSpaceId(),type:s.getType()},userAction:n}}})}}({environment:t,sourceBlockPointer:a,recordLimit:p,userAction:d,targetBlockStore:o,loadLocalSubtreeArgs:g}));v&&!v.recordMap&&r().log({level:"warning",from:"attemptServerBackedLocalDuplicate",type:"subtreeLoadFailure",data:{message:"Failed to load subtree",miscDataToConvertToString:{sourceBlockPointer:a,cacheSize:o.inMemoryRecordCache.size,reason:"error"===v.type?v.reason:void 0,targetBlockPointer:{id:o.id,spaceId:o.getSpaceId(),type:o.getType()},missingRecord:"error"===v.type?v.pointer:void 0,userAction:d}}});return v}({environment:t,sourceBlockPointer:a,targetBlockStore:o,targetInMemoryRecordCache:v,options:p,enableLegacyTransclusionFixing:y,recordLimit:u,userAction:n});if(null==_||_.mark("try_load_local_subtree_finished"),!I||!I.recordMap)return{success:!1,size:void 0,pageStore:o};var k;if(a.spaceId&&f().Lw({sourceSpaceId:a.spaceId,targetSpaceId:o.getSpaceId(),sourceBlockSubtree:I.recordMap}))return r().log({level:"warning",from:"attemptServerBackedLocalDuplicate",type:"accessLockingWarning",data:{message:"Unable to perform local duplication",miscDataToConvertToString:{sourceBlockPointer:a,targetBlockPointer:{id:o.id,spaceId:o.getSpaceId(),type:o.getType()},userAction:n}}}),null==_||_.mark("attempt_server_backed_local_duplicate_failure"),{success:!1,size:null===(k=I.recordMap)||void 0===k?void 0:k.getSize(),pageStore:o};for(const c of I.recordMap.getTables()){var S;if(c===s().yB||c===l().SC)return r().log({level:"warning",from:"attemptServerBackedLocalDuplicate",type:"invalidRecordType",data:{message:"Local duplication does not support automation tables",miscDataToConvertToString:{sourceBlockPointer:a,targetBlockPointer:{id:o.id,spaceId:o.getSpaceId(),type:o.getType()},userAction:n}}}),null==_||_.mark("attempt_server_backed_local_duplicate_failure"),{success:!1,size:null===(S=I.recordMap)||void 0===S?void 0:S.getSize(),pageStore:o}}try{var h;ie({environment:t,type:"server_backed_duplicate_start_transaction",data:{message:"Starting transactionActions.createAndCommit for localDuplicate",sourceBlockPointer:a,targetBlockPointer:{id:o.id,spaceId:o.getSpaceId(),type:o.getType()},userAction:n}});const{serverCommitResult:e}=P().createAndCommit({userAction:n,environment:t,canUndo:!0,isTemplateInstantiationTransaction:Boolean(d),perform:e=>ee({environment:t,sourceBlockId:a.id,targetBlockPointer:o.pointer,sourceBlockSubtree:I.recordMap,targetInMemoryRecordCache:o.inMemoryRecordCache,transaction:e,templateInstallationMetadata:d,actionStartTimestamp:g,stopwatch:_,options:{...p,preventLegacyTransclusions:y}})});return await e,null==_||_.mark("server_backed_local_duplicate_finished"),ie({environment:t,type:"server_duplicate_attempt_server_backed_local_duplicate_success",data:{targetSpaceId:o.getSpaceId(),options:p}}),{success:!0,size:null===(h=I.recordMap)||void 0===h?void 0:h.getSize(),pageStore:o,transactionPromise:e}}catch(T){var B;return r().log({level:"error",from:"attemptServerBackedLocalDuplicate",type:"subtreeLoadError",error:(0,m().convertErrorToLog)(T),data:{message:"Failed to load subtree",miscDataToConvertToString:{sourceBlockPointer:a,targetBlockPointer:{id:o.id,spaceId:o.getSpaceId(),type:o.getType()},userAction:n}}}),{success:!1,size:null===(B=I.recordMap)||void 0===B?void 0:B.getSize(),pageStore:o}}}function re(e){const{environment:t,stores:a,transaction:o,targetSpaceId:r,preferDuplicateLocation:n,analyticsFrom:c,options:i,installationImprint:s,applyTranslationMap:l,shouldAttemptServerBackedLocalDuplication:m,templateInstallationMetadata:g,shouldUseSynchronousDuplicationAPI:_}=e,y=performance.now(),I=new U({environment:t,metricName:"duplicate_block_stopwatch",extraData:{duplication_type:"local"===n?"local_duplication":m?"server_backed_local_duplication":_?"server_synchronous_duplication":"server_duplication",from:c}});if(0===a.length)throw new Error("Must duplicate at least one block");const k=a[0].getSpaceId();if(!a.every((e=>e.getSpaceId()===k)))throw new Error("All stores must be in the same space");if(a.length>1&&!a.every((e=>e.isTypedCollectionViewBlock())))throw new Error("Multiple source blocks only supported for grouped typed DB duplication");if((0,v().O9)(l)&&1!==a.length&&!a[0].isPageBlock())throw new Error("applyTranslationMap currently only supported for single page block duplication");!function(e){const{environment:t,stores:a,analyticsFrom:o}=e;for(const n of a){const e=n.getRecordStoreAtRootPath().getValue();let a;const{currentSpaceStore:c}=V().default.getState();var r;if(c&&(null==e?void 0:e.parent_table)===u().yK&&(a=$().h4.createChildStore(c,{table:u().yK,id:e.parent_id})),e)S().v(t,{from:o??"copy",type:e.type,teamStore:a,is_toggleable:(0,N().Yt)(e.type,e.format),collection_id:n.getAssociatedCollectionId()??(null===(r=n.getCollectionStore())||void 0===r?void 0:r.id),new_page_id:"page"===e.type?n.id:void 0,creating_block_id:n.id,parent_collection_id:n.getParentCollectionIdUpToTwoLevels(),form_id:n.getFirstFormIdInCollectionViewBlock()})}}({environment:t,stores:a,analyticsFrom:c}),I.mark("track_create_blocks");const h=k!==r,b=g&&(0,d().Fe)(g.source)&&g.isListedTemplate;if("local"===n&&1===a.length&&!b){const e=function(e){const{environment:t,store:a,sourceSpaceId:o,targetSpaceId:r,transaction:n,options:c,installationImprint:i,templateInstallationMetadata:s,actionStartTimestamp:l,stopwatch:d}=e,u=(0,x().$J)(),m=(0,Q().loadLocalSubtree)(t,{blockId:a.id,inMemoryRecordCache:a.inMemoryRecordCache,allowCopyCollections:!1,requireFullSubtree:!0,skipTransclusionContainerChildren:!c.deepCopyTransclusionContainers,allowCopyExternalObjectInstances:!c.convertExternalObjectInstancesToPlaceholders,includeLegacyTransclusionBlockValues:u}).recordMap;if(null==d||d.mark("load_local_subtree"),m&&!f().Lw({sourceSpaceId:o,targetSpaceId:r,sourceBlockSubtree:m})){const{targetBlockStore:e}=ee({environment:t,sourceBlockId:a.id,targetBlockPointer:(0,E().zP)({environment:t,table:p().ev,spaceId:r}),sourceBlockSubtree:m,targetInMemoryRecordCache:a.inMemoryRecordCache,options:{...c,preventLegacyTransclusions:u},transaction:n,installationImprint:i,templateInstallationMetadata:s,actionStartTimestamp:l,stopwatch:d});return"ai_block"===e.getType()&&w().EF.setState(e.pointer.id),{blockStores:[e],onComplete:Promise.resolve({status:"success"})}}}({environment:t,store:a[0],options:{...i,convertExternalObjectInstancesToPlaceholders:h},sourceSpaceId:k,targetSpaceId:r,transaction:o,installationImprint:s,templateInstallationMetadata:g,actionStartTimestamp:y,stopwatch:I});if(e)return I.mark("try_local_duplication_success"),I.end(),e;I.mark("try_local_duplication_failure")}if(a.some((e=>e.inMemoryRecordCache!==t.defaultRecordCache.inMemoryRecordCache)))throw new Error("Can only server duplicate from the environment.defaultRecordCache.inMemoryRecordCache.");const B=t.defaultRecordCache.inMemoryRecordCache;j().A.state.online||T().f1(z().A.formatMessage(q().V.offlineError));const C=te({environment:t,sourceBlocks:a.map((e=>({id:e.id,spaceId:e.getSpaceId()}))),targetInMemoryRecordCache:B,transaction:o,targetSpaceId:r,installationImprint:s,templateInstallationMetadata:g,applyTranslationMap:l,shouldAttemptServerBackedLocalDuplication:m,actionStartTimestamp:y,stopwatch:I,shouldUseSynchronousDuplicationAPI:_,options:{...i,convertExternalObjectInstancesToPlaceholders:h}});return async function(){const{blockStores:e,onComplete:t}=C;if("success"===(await t).status)for(const a of e)if("ai_block"===a.getType())return void w().EF.setState(a.pointer.id)}(),I.mark("duplicate_block_immediate_return"),C}function ne(e){if(!e)return!1;const t=J().default.getConfigKey("enabled_installation_sources_for_duplicate_template_block",e);return Boolean(t)}function ce(e,t,a){return Boolean(e&&t&&a)&&J().default.checkGate({gateName:"translate_template_top_bar"})}function ie(e){const{environment:t,type:a,data:o}=e;pe({environment:t,level:"info",from:"duplicateActions",type:a,data:o})}function se(e){const{environment:t,type:a,data:o}=e;pe({environment:t,level:"warning",from:"duplicateActions",type:a,data:o})}function le(e){const{environment:t,type:a,data:o}=e;pe({environment:t,level:"error",from:"duplicateActions",type:a,data:o})}function pe(e){const{environment:t,level:a,from:o,type:n,data:c}=e,i=J().default.getConfigKey("page_template_duplication_verbose_logging_config","userIds");t.currentUser.id&&i.includes(t.currentUser.id)&&r().log({level:a,from:o,type:n,data:c})}}}]);