"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[17586,90966],{191458:(e,t,o)=>{o.r(t),o.d(t,{loadWorkflowTemplateInstances:()=>l});o(944114),o(581454);var n=()=>o(912720),r=()=>o(534177),i=()=>o(630116);const a=!1;function l(e){const t=[];let o=!1;e.isDefined()||(o=!0);const l=e=>{var n;if(!e.isDefined())return void(o=!0);const r=null===(n=e.getProperties())||void 0===n?void 0:n.workflow_template_instance;r&&t.push({instancePointer:{type:"automation",id:e.id,spaceId:e.getSpaceId()},templateId:r.template_id})},c=e.getFormat().workflow_template_instance,p=e.getParentBlockStore();if(null==p||!p.isDefined())return{isLoading:!0,instances:[]};c&&t.push({instancePointer:{type:"collection",id:e.id},templateId:c.template_id});const s=p.getCollectionViewStores()??[];for(const n of s){if(!n.isDefined()){o=!0;continue}const e=n.getFormat().workflow_template_instance;e&&t.push({instancePointer:{type:"collection_view",id:n.id},templateId:e.template_id})}const d=e.getLayoutStore();if(d)if(d.isDefined()){var m;const e=null===(m=d.getFormat())||void 0===m?void 0:m.workflow_template_instance;e&&t.push({instancePointer:{type:"layout",id:d.id,spaceId:d.getSpaceId()},templateId:e.template_id})}else o=!0;const u=e.getTemplatePageStores();for(const n of u){const e=n.getModel();if(!e){o=!0;continue}if(!e.isPageBlock())continue;const r=e.getFormat().workflow_template_instance;r&&t.push({instancePointer:{type:"block",id:e.id,spaceId:e.getSpaceId()},templateId:r.template_id});const i=n.getAutomationStore();i&&l(i)}const f=e.getAutomationStores();for(const n of f)l(n);const y=e.getSpaceId(),I=e.getSchema();for(const[r,a]of Object.entries(I)){if(!a)continue;const o=a.workflow_template_instance;if(o&&t.push({instancePointer:{type:"property",id:r,collectionId:e.id},templateId:o.template_id}),"button"===a.type&&a.automation_id){l(i().dn.createChildStore(e,{id:a.automation_id,spaceId:y,table:n().yB}))}}const g=e.getFormat().compound_workflow_template_instances??[];for(const n of g)t.push({instancePointer:{type:"compound",id:n.id,collectionId:e.id,instancePointers:n.instance_pointers.map((t=>{switch(t.type){case"automation":return{type:"automation",id:t.id,spaceId:y};case"block":return{type:"block",id:t.id,spaceId:y};case"collection_view":return{type:"collection_view",id:t.id};case"layout":return{type:"layout",id:t.id,spaceId:y};case"property":return{type:"property",id:t.id,collectionId:e.id}}(0,r().HB)(t)}))},templateId:n.template_id});return a&&console.log("loadWorkflowTemplateInstances: loaded workflow template instances for collection:",e.id,"isLoading:",o,"instances:",t),{isLoading:o,instances:t}}},204067:(e,t,o)=>{o.d(t,{CB:()=>b,DM:()=>x,FE:()=>E,Fy:()=>L,NU:()=>W,R5:()=>F,S1:()=>R,Sl:()=>T,TE:()=>P,Xg:()=>B,Zp:()=>O,aI:()=>j,aL:()=>z,b3:()=>h,fI:()=>k,ju:()=>S,rS:()=>D,tY:()=>$,wW:()=>A});o(16280),o(944114),o(898992),o(354520),o(672577),o(430670),o(581454),o(737550);var n=()=>o(888325),r=()=>o(663077),i=()=>o(857639),a=()=>o(912720),l=()=>o(179034),c=()=>o(519831),p=()=>o(869558),s=()=>o(144081),d=()=>o(496603),m=()=>o(534177),u=()=>o(108944),f=()=>o(630116),y=()=>o(299177),I=()=>o(191458),g=()=>o(913454);const w=!1;function h(e){const t={};for(const o of e){const e=t[o.templateId]??[];e.push(o.instancePointer),t[o.templateId]=e}return t}function v(e){let t;if("collection"===e.table)t=h((0,I().loadWorkflowTemplateInstances)(e).instances);else{const o=(0,n()._)(e.pointer),r=y().A.getState();t=(null==r?void 0:r[o])??{}}const o=S(t);return w&&(console.groupCollapsed("getTemplateIdToInstancePointersMap",e.pointer),console.trace(),console.log("Raw map:",t),console.log("Map with invalid template IDs removed:",o),console.groupEnd()),o}function S(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:g().globalWorkflowTemplates;const o={},n=(0,d().Bj)((e=>{try{return t.fromId(e),!0}catch(o){return!1}}));for(const[r,i]of Object.entries(e))n(r)&&(o[r]=i);return o}function T(e){let{environment:t,collectionStore:o}=e;const n=v(o),r=[];for(const[i,a]of Object.entries(n))for(const e of a)j({environment:t,instancePointer:e,inMemoryRecordCache:o.inMemoryRecordCache})&&r.push({instancePointer:e,templateId:i});return r}const _="dependency_";function P(e){return e.startsWith(_)}function b(e){let{collectionStore:t,sourceTemplateType:o,sourcePrimitiveId:n,dependencyMap:r}=e;const i=C({sourceTemplateType:o,sourcePrimitiveId:n,dependencyMap:r});if(!i)return n;const a=M(t,i);if(0===a.length)return`${_}${i}`;return a[a.length-1].id}function k(e){let{collectionStore:t,sourceTemplateType:o,sourcePrimitiveId:n,dependencyMap:r}=e;const i=C({sourceTemplateType:o,sourcePrimitiveId:n,dependencyMap:r});if(!i)return;const a=M(t,i);if(0===a.length)return;return a[a.length-1].id}function C(e){let{sourceTemplateType:t,sourcePrimitiveId:o,dependencyMap:n}=e;if(P(o))return o.replace(_,"");return n[(0,r().Ir)(t,o)]}function M(e,t){return v(e)[t]??[]}function A(e){let{environment:t,spaceStore:o,templateId:n}=e;return M(o,n).filter((e=>j({environment:t,instancePointer:e,inMemoryRecordCache:o.inMemoryRecordCache})))}function R(e){let{collectionStore:t,templateId:o,instancePointerType:n}=e;const r=M(t,o);if(0===r.length)return;const i=r[r.length-1];if(i.type!==n)throw new Error(`Expect to find instance pointer type ${n} for template ID ${o} but found ${i.type} instead`);return i}function W(e){let{environment:t,collectionStore:o,templateId:n}=e;return Boolean(O({environment:t,scopeStore:o,templateId:n}))}function O(e){let{environment:t,scopeStore:o,templateId:n}=e;const r=o.pointer,a=M(o,n).filter((e=>j({environment:t,instancePointer:e,inMemoryRecordCache:o.inMemoryRecordCache}))),l=(0,d().hS)(a,(e=>e.id));if(l.length!==a.length){const e=a.map((e=>e.id));i().log({level:"warning",from:"workflowTemplatesInstanceHelpers",type:"duplicateAliveInstancePointers",data:{miscDataToConvertToString:{templateId:n,instanceIds:e}}})}return 0===l.length?void 0:l.length>1?(i().log({level:"warning",from:"workflowTemplatesInstanceHelpers",type:"moreThanOneAliveInstancePointer",data:{miscDataToConvertToString:{templateId:n,scope:r,uniqueAliveInstancePointers:l}}}),l[0]):l[0]}function j(e){let{environment:t,instancePointer:o,inMemoryRecordCache:n}=e;if("property"===o.type){const e=new(f().md)(t,{table:c().Vl,id:o.collectionId},{inMemoryRecordCache:n});return Boolean(e.getSchema()[o.id])}if("collection_view"===o.type){const e=new(f().pS)(t,{table:p().Gy,id:o.id},{inMemoryRecordCache:n});return Boolean(e.getAlive())}if("collection"===o.type){const e=new(f().md)(t,{table:c().Vl,id:o.id},{inMemoryRecordCache:n});return!(0,u().ze)(e)}if("layout"===o.type){const e=new(f().K_)(t,{table:s().zx,id:o.id,spaceId:o.spaceId},{inMemoryRecordCache:n});return!(0,u().ze)(e)}if("compound"===o.type)return function(e){let{environment:t,instancePointer:o,inMemoryRecordCache:n}=e;return o.instancePointers.some((e=>j({environment:t,instancePointer:e,inMemoryRecordCache:n})))}({environment:t,instancePointer:o,inMemoryRecordCache:n});if("block"===o.type){const e=new(f().Bv)(t,{table:l().ev,id:o.id,spaceId:o.spaceId},{inMemoryRecordCache:n});return!(0,u().ze)(e)}if("automation"===o.type){const e=new(f().dn)(t,{table:a().yB,id:o.id,spaceId:o.spaceId},{inMemoryRecordCache:n});return!(0,u().ze)(e)}(0,m().HB)(o)}function B(e,t){const o=v(t);return Object.keys(o).filter((o=>W({environment:e,collectionStore:t,templateId:o}))).map((e=>g().globalWorkflowTemplates.fromId(e)))}function D(e,t){const o=[],n=v(e);for(const r of Object.values(n))o.push(...r.filter((e=>e.type===t)));return o}function $(e){let{environment:t,collectionStore:o}=e;if(!o)return;const n=T({environment:t,collectionStore:o}).filter((e=>{let{instancePointer:t}=e;return"collection"===t.type&&t.id===o.id}));if(0!==n.length){if(n.length>1)throw new Error(`More than one collection preset templates found for collection ${o.id}`);return g().globalWorkflowTemplates.fromIdOfType({templateId:n[0].templateId,type:"collection"})}}function x(e){const{type:t}=e;return"collection_view"===t||"property"===t||"layout"===t||"compound"===t||"block"===t||"automation"===t}function E(e){let{environment:t,collectionStore:o}=e;return T({environment:t,collectionStore:o}).filter((e=>"compound"===e.instancePointer.type))}function L(e){let{environment:t,collectionStore:o,instancePointerId:n}=e;const r=T({environment:t,collectionStore:o}).find((e=>e.instancePointer.id===n));if(r)return g().globalWorkflowTemplates.featureFromId(r.templateId)}function N(e){let{environment:t,collectionStore:o,propertyId:n}=e;const r=function(e){let{environment:t,collectionStore:o,propertyId:n}=e;return T({environment:t,collectionStore:o}).filter((e=>"property"===e.instancePointer.type&&e.instancePointer.id===n))}({collectionStore:o,environment:t,propertyId:n}),i=E({environment:t,collectionStore:o}).filter((e=>{let{instancePointer:t}=e;return r.some((e=>t.instancePointers.some((t=>t.id===e.instancePointer.id))))}));return{propertyTemplateInstances:r,compoundTemplateInstances:i}}function F(e){let{collectionStore:t,environment:o,propertyId:n}=e;const{propertyTemplateInstances:i,compoundTemplateInstances:a}=N({environment:o,collectionStore:t,propertyId:n}),l=i.map((e=>{let{templateId:t}=e;return g().globalWorkflowTemplates.fromId(t)})).filter((e=>(0,r().Xq)(e,"property")));return a.filter((e=>{let{templateId:t}=e;const o=g().globalWorkflowTemplates.fromId(t);if((0,r().Xq)(o,"compound"))return l.some((e=>o.value.templateItems.some((t=>t.pointer===e.templateId&&"required"===t.optionality))))}))}function z(e){let{environment:t,collectionStore:o,compoundTemplateInstancesToDelete:n}=e;const r=n.flatMap((e=>e.instancePointer.instancePointers)),i=n.map((e=>e.instancePointer.id)),a=E({environment:t,collectionStore:o}),l=[];for(const c of a)if(!i.includes(c.instancePointer.id))for(const e of c.instancePointer.instancePointers)r.some((t=>t.id===e.id))&&l.push(e);return r.filter((e=>!l.some((t=>t.id===e.id))))}},290966:(e,t,o)=>{o.d(t,{E_:()=>A,HQ:()=>O,I5:()=>R,ZQ:()=>M});o(16280),o(898992),o(823215),o(354520),o(581454),o(296540);var n=()=>o(662303),r=()=>o(428045),i=()=>o(134025),a=()=>o(912720),l=()=>o(179034),c=()=>o(519831),p=()=>o(869558),s=()=>o(144081),d=()=>o(921515),m=()=>o(959013),u=()=>o(496603),f=()=>o(534177),y=()=>o(284371),I=()=>o(966759),g=()=>o(235191),w=()=>o(901389),h=()=>o(751156),v=()=>o(67103),S=()=>o(16006),T=()=>o(972435),_=()=>o(470928),P=()=>o(630116),b=()=>o(913454),k=()=>o(204067),C=o(474848);function M(e){let{transaction:t,collectionStore:o,templateId:n,instance:r,logger:m}=e;m.debug(`Creating/updating ${d().rM} record for "${n}".`);const u=o.getSpaceId(),y=r.id;if("automation"===r.type){const e={table:a().yB,id:y,spaceId:u};h().applyOperation({store:P().dn.createChildStore(o,e),operation:i().op.set({pointer:e,path:["properties","workflow_template_instance"],args:{template_id:n}}),transaction:t})}else if("block"===r.type){const e={table:l().ev,id:y,spaceId:u};h().applyOperation({store:P().Bv.createChildStore(o,e),operation:i().op.set({pointer:e,path:["format","workflow_template_instance"],args:{template_id:n}}),transaction:t})}else if("collection"===r.type){const e={table:c().Vl,id:y,spaceId:u};h().applyOperation({store:o,operation:i().op.set({pointer:e,path:["format","workflow_template_instance"],args:{template_id:n}}),transaction:t})}else if("collection_view"===r.type){const e={table:p().Gy,id:y,spaceId:u};h().applyOperation({store:P().pS.createChildStore(o,e),operation:i().op.set({pointer:e,path:["format","workflow_template_instance"],args:{template_id:n}}),transaction:t})}else if("layout"===r.type){const e={table:s().zx,id:y,spaceId:u};h().applyOperation({store:P().K_.createChildStore(o,e),operation:i().op.set({pointer:e,path:["format","workflow_template_instance"],args:{template_id:n}}),transaction:t})}else if("compound"===r.type){if(r.instancePointers.length<2)throw new Error(`Compound template instance ${r.id} must contain 2 or more instances`);const e=r.instancePointers.map((e=>{switch(e.type){case"automation":return{type:"automation",id:e.id};case"block":return{type:"block",id:e.id};case"collection_view":return{type:"collection_view",id:e.id};case"layout":return{type:"layout",id:e.id};case"property":return{type:"property",id:e.id}}(0,f().HB)(e)}));h().applyOperation({store:o,operation:{command:"keyedObjectListUpdate",pointer:o.pointer,path:["format","compound_workflow_template_instances"],args:{value:{template_id:n,id:r.id,instance_pointers:e}}},transaction:t})}else"property"===r.type?h().applyOperation({store:o,operation:i().op.update({pointer:o.pointer,path:["schema",r.id],args:{workflow_template_instance:{template_id:n}}}),transaction:t}):(0,f().HB)(r)}function A(e){let{environment:t,collectionStore:o,propertyId:n,compoundTemplateInstancesToDelete:i,collectionContextStore:a,from:l}=e;if(!i.every((e=>e.templateId===r().z$)))return!1;if(!(0,_().Io)())return!1;const c=(0,k().aL)({environment:t,collectionStore:o,compoundTemplateInstancesToDelete:i}),p=u().sb(c.filter((e=>"property"===e.type)).map((e=>e.id))),s=o.getSchema(),d=p.map((e=>{var t;if(e===n)return;const o=s[e];if(!o)throw new Error(`Property ${e} not found`);if(o.name)return o.name;const r=null===(t=o.workflow_template_instance)||void 0===t?void 0:t.template_id;if(!r)throw new Error(`Property ${e} has no workflow template id`);const i=b().globalWorkflowTemplates.fromId(r);return(0,b().getWorkflowTemplateName)(i)})).filter(f().O9);return W({environment:t,collectionStore:o,propertyIds:p,otherPropertyNames:d,collectionContextStore:a,from:l}),!0}function R(e){let{environment:t,collectionStore:o,propertyId:n,collectionContextStore:r,from:i}=e;const a=o.getSchema(),l=Object.keys(a).filter((e=>(0,_().Do)({collectionStore:o,propertyId:e})||(0,_().k$)(e))),c=l.map((e=>{var t;if(e===n)return;const r=null===(t=a[e])||void 0===t?void 0:t.name;if(r)return r;if((0,_().Do)({collectionStore:o,propertyId:e}))return T().A.formatMessage(v().Gl.verificationPropertyName);if((0,_().k$)(e))return T().A.formatMessage(v().Gl.ownerPropertyName);throw new Error(`Property ${e} must be a verification or owner property`)})).filter(f().O9);return W({environment:t,collectionStore:o,propertyIds:l,otherPropertyNames:c,collectionContextStore:r,from:i}),!0}function W(e){let{environment:t,collectionStore:o,propertyIds:r,otherPropertyNames:i,collectionContextStore:a,from:l}=e;const c=[{label:(0,C.jsx)(m().sA,{id:"workflowTemplateInstanceActions.deleteRequiredProperty.deleteOption",defaultMessage:"{count, plural, one {Delete {count} property} other {Delete {count} properties}}",values:{count:r.length}}),color:"red",onAccept:()=>function(e){let{environment:t,collectionStore:o,collectionContextStore:n,propertyIds:r,from:i}=e;h().createAndCommit({userAction:"workflowTemplateInstanceActions.handleDeleteAccept",environment:t,canUndo:!0,perform:e=>{const a=o.getSchema();for(const l of r){g().BJ({environment:t,collectionStore:o,schema:a,property:l,transaction:e});const r=a[l];r&&(0,I().i)({environment:t,collectionContextStore:n,property_type:r.type,from:i,property:l})}}})}({environment:t,collectionStore:o,collectionContextStore:a,propertyIds:r,from:l})}],p=new Intl.ListFormat(n().locale,{style:"long",type:"conjunction"}),s=(0,C.jsx)(m().sA,{id:"workflowTemplateInstanceActions.deleteRequiredProperty.deletePropertyFromDb",defaultMessage:"Delete this property from <bold>{databaseName}</bold>? {otherPropertyNames} will also be deleted",values:{bold:e=>(0,C.jsx)("span",{style:{fontWeight:y().Wy.bold},children:e}),databaseName:(0,C.jsx)(S().A,{style:{display:"inline",fontWeight:y().Wy.bold},shouldWrap:!0,store:o}),otherPropertyNames:p.format(i)}});w().ui({message:(0,C.jsx)("span",{children:s}),showCancel:!0,keepFocus:!0,innerStyle:{width:400},items:c})}function O(e){const{environment:t,transaction:o,collectionStore:n,instance:r}=e;(0,k().aI)({environment:t,instancePointer:r,inMemoryRecordCache:n.inMemoryRecordCache})||h().applyOperation({store:n,operation:{pointer:n.pointer,command:"keyedObjectListRemove",path:["format","compound_workflow_template_instances"],args:{remove:{id:r.id}}},transaction:o})}},605315:(e,t,o)=>{o.d(t,{Z:()=>r});class n extends(()=>o(757695))().default{getInitialState(){return{}}append(e){const t={...this.state};for(const o of e)t[o.templateId]=o;this.setState(t)}}const r=new n},863987:(e,t,o)=>{o.d(t,{A:()=>i});class n extends(()=>o(757695))().default{getInitialState(){return null}}const r=new n;o(604341).exposeDebugValue("WorkflowTemplatesBuilderStore",r);const i=r},913454:(e,t,o)=>{o.r(t),o.d(t,{TRUNCATE_COLLECTION_TEMPLATE_ITEMS_AT:()=>R,WorkflowTemplateLogger:()=>h,getChildCollectionStoreByTemplateId:()=>C,getCollectionTemplateFromId:()=>B,getIsSetupGeneratorEnabled:()=>W,getPropertyTemplates:()=>A,getSelectedFeatureTemplateIds:()=>k,getTemplatesInCompoundTemplate:()=>M,getWorkflowTemplateItemsCaption:()=>P,getWorkflowTemplateName:()=>b,globalWorkflowTemplates:()=>S,remapPropertyIds:()=>T,shouldShowInSuggestedProperties:()=>O,useCaseByCollectionTemplateCategory:()=>j});o(16280),o(944114),o(898992),o(823215),o(354520),o(672577),o(581454);var n=()=>o(663077),r=()=>o(278132),i=()=>o(992437),a=()=>o(388821),l=()=>o(696706),c=()=>o(519831),p=()=>o(96689),s=()=>o(919709),d=()=>o(496603),m=()=>o(534177),u=()=>o(403905),f=()=>o(68465),y=()=>o(972435),I=()=>o(630116),g=()=>o(204067);const w=(0,o(959013).YK)({untitled:{id:"workflowTemplates.untitled",defaultMessage:"Untitled"}});class h{log(e){0}warn(e){0}debug(e){false}}const v=new(o(496506).default)((()=>{var e;const t=y().A.getIntl();return(0,o(104119).IC)({},t,(null===(e=o(863987).A.state)||void 0===e?void 0:e.templatesWithRowIds.map((e=>e.template)))??[],{shouldFakeLocalization:"pseudo"===t.locale,strict:!1})}),{debugName:"localizedDynamicBuilderTemplatesStore"}),S=new(n().GH)((e=>{const t=y().A.getIntl(),n=[...v.state,...(0,o(428045).Cb)(t,{localizeTemplates:!0,stage:(0,o(338907).M)()}),...Object.values(o(605315).Z.state)].find((t=>t.templateId===e));if(!n)throw new Error(`Template not found for ${e}`);return n}));function T(e){let{collectionStore:t,dependencyMap:o,object:r}=e;(0,n().$G)({object:r,callback:e=>function(e){let{collectionStore:t,dependencyMap:o,objectWithProperty:n}=e;const r=n.property,i=(0,g().CB)({collectionStore:t,sourceTemplateType:"property",sourcePrimitiveId:r,dependencyMap:o});n.property=i}({collectionStore:t,dependencyMap:o,objectWithProperty:e})})}const _=3;function P(e){if(0===e.length)return;const t=e.slice(0,_),o=e.length-t.length,n=t.join(", ");return o>0?`${n}, ${o}+`:n}function b(e){const{type:t}=e;switch(t){case"collection_view":return e.value.name??y().A.formatMessage(u().X[e.value.type]);case"property":return e.value.name;case"collection":return e.value.targetCollection.name;case"layout":case"compound":return e.name;case"block":const o=a().RecordMap.create(e.value.recordMap),n=o.getModel(e.value.blockPointer);return n?(0,s().q4_)(n.getRenderTitleTextValue({getRecordModel:i().b.fromRecordMap(o)})):y().A.formatMessage(w.untitled);case"automation":return e.value.name??(0,r().PK)(y().A.getIntl());default:(0,m().HB)(t)}}function k(e){return e.featureTemplateSelections.filter((e=>e.selected)).map((e=>e.template.templateId))}function C(e){let{environment:t,parentStore:o,collectionTemplateId:n}=e;const r=o.getSpaceId();if(!r)throw new Error(`Space ID not found for ${o}`);const i=new(I().SL)(t,{table:p().NX,id:r}),a=(0,g().wW)({environment:t,spaceStore:i,templateId:n});for(const p of a){var s;const e=new(I().md)(t,{table:c().Vl,id:p.id}),n=null===(s=e.getParentBlockStore())||void 0===s?void 0:s.getParentPointer();if(n&&l().L3.isEqual(n,o.pointer))return e}}function M(e){const t=e.value.templateItems.map((e=>S.fromId(e.pointer))),o=[];for(const r of t){if(!(0,n().$K)(r))throw new Error(`Invalid template "${r.templateId}" in compound template "${e.templateId}"`);o.push(r)}return o}function A(e){const t=[];for(const o of e)"property"===o.type?t.push(o):"compound"===o.type&&t.push(...M(o).filter((e=>(0,n().Xq)(e,"property"))));return d().hS(t,(e=>e.templateId))}const R=3;function W(e){return(0,f().ZE)(e)}function O(e){return"property"===e.type||"compound"===e.type&&M(e).every((e=>"property"===e.type))}const j={goals:"goals",projects:"project",tasks:"other",docs:"docs",meetings:"notes"};function B(e){try{return S.fromIdOfType({templateId:e,type:"collection"})}catch(t){return}}}}]);